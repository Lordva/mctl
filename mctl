#!/bin/bash

MINECRAFT_START_COMMAND="/usr/bin/java -Xms2G -Xmx8G -jar ${SERVER_FILE} nogui"
ISHARD=false

# The server's base directory without the ending /
SERVER_PATH="/srv/mc"

# The linux user running the server
SERVER_USER="minecraft"
SERVER_GROUP="minecraft"

#the name of the server file, could be forge.jar or spigot.jar, usualy it should be server.jar
SERVER_FILE="server.jar"

#wip
SHELL_PID=$$
PID_FILE="/tmp/mctl_pid"

TMUX_SESSION_NAME="minecraft"
TMUX_SOCKET_PATH="/tmp/console_socket"

progress-bar() {
  local duration=${1}
    already_done() { for ((done=0; done<$elapsed; done++)); do printf "â–‡"; done }
    remaining() { for ((remain=$elapsed; remain<$duration; remain++)); do printf " "; done }
    percentage() { printf "| %s%%" $(( (($elapsed)*100)/($duration)*100/100 )); }
    clean_line() { printf "\r"; }
  for (( elapsed=1; elapsed<=$duration; elapsed++ )); do
      already_done; remaining; percentage
      sleep 1
      clean_line
  done
  clean_line
}

check_if_running(){
  if [ -e $PID_FILE ]; then
    PID=cat $PID_FILE
    if ps -p $PID; then
      echo -e "[ERROR] minecraft server is already running. see mctl status for more information"
      exit 1
    fi
    rm $PID_FILE
  fi
  if tmux -S $TMUX_SOCKET_PATH ls | grep $TMUX_SESSION_NAME > /dev/null 2>&1; then
    echo -e "[ERROR] tmux session exist but is running empty, delete session and retry"
    exit 1
  fi
}

function start(){
  check_if_running 
  echo -e "[LOG] executing start command"
  sudo runuser -l minecraft -c "tmux -S /tmp/console_socket new -s minecraft -d 'bash /srv/mc/start.sh'" 
  exit 0
}

function stop(){
  if ! tmux -S $TMUX_SOCKET_PATH ls | grep $TMUX_SESSION_NAME > /dev/null 2>&1; then
    echo -e "[ERROR] cannot stop server, server is offline"
    exit 1
  fi
  if [ $ISHARD == false ]; then
    tmux -S $TMUX_SOCKET_PATH send-keys -t $TMUX_SESSION_NAME 'say Arret du serveur dans 30 secondes' Enter
    echo -e "[LOG] sleeping for 30s..."
    progress-bar 30
    echo -e "done"
  fi
  tmux -S $TMUX_SOCKET_PATH send-keys -t $TMUX_SESSION_NAME 'say Arret du serveur !' Enter
  sleep 3
  tmux -S $TMUX_SOCKET_PATH send-keys -t $TMUX_SESSION_NAME 'stop' Enter
  tmux -S $TMUX_SOCKET_PATH kill-session -t $TMUX_SESSION_NAME
  exit 0
}

function console(){
  check_if_running
  tail -f "$SERVER_PATH/logs/latest.log"
  read -p "> " input
  tmux -S $TMUX_SOCKET_PATH send-keys -t $TMUX_SESSION_NAME "${input}" Enter
  exit 0
}

function status(){
  if tmux -S $TMUX_SOCKET_PATH ls | grep $TMUX_SESSION_NAME > /dev/null 2>&1; then
    STATUS="running"
  else
    STATUS="stopped"
  fi
  echo $SHELL_PID
  ps -A -o 'ppid pid command' | grep $SHELL_PID
  exit 0
}

function restart(){
  stop
  start
  exit 0
}

function help(){
  echo -e "usage: mctl [option] <command>"
  echo -e ""
  echo -e "commands:"
  echo -e "mctl start                   start the minecraft server"
  echo -e "mctl stop                    stop the minecraft server"
  echo -e "mctl status                  display the status for the minecraft server"
  echo -e "mctl restart                 restart the minecraft server"
  echo -e "mctl console                 display the server console"
  echo
  echo -e "options: "
  echo -e "mctl -s --send               send command to console without opening it"
  echo -e "mctl -h, --help              display this message"
  echo -e "mctl -f --force              force the event execution without prior warning"
  exit 1
}

function version(){
  echo -e "mctl 0.1.2"
  exit 0
}

if [ $# -gt 2 ]; then
  echo -e "[ERROR] too many arguments."
  help
fi

for i in "$@"; do case $i in
  start ) start ;;
  stop ) stop ;;
  restart ) restart ;;
  status ) status ;;
  console ) console ;;
  -h | --help ) help ;;
  -f | --force ) ISHARD=true ;;
  * ) echo -e "[ERROR] Invalid argument" && help ;;
esac
done

echo -e "[ERROR] program require a command"
help

